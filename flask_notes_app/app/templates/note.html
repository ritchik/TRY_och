<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ note.title }}</title>

    <style>
        .note-content {
            white-space: pre-wrap;
            font-family: inherit;
        }
    </style>
</head>

<body>
    <h1>{{ note.title }}</h1>

    {% if note.encrypted %}
    {% if content %}
    {# Decryption Successful #}
    <div class="note note-content">{{ content }}</div>

    {% if note.attachments %}
    <div>
        <h3>Attachments</h3>
        <ul>
            {% for attachment in note.attachments %}
            <li>
                <strong>{{ attachment.filename }}</strong>
                <span>({{ (attachment.size / 1024)|round(1) }} KB)</span>
                <form action="{{ url_for('main.download_attachment', attachment_id=attachment.id) }}" method="POST">
                    <button type="submit">Download</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% else %}
    {# Decryption Failed or Key Missing #}
    <div class="alert alert-danger"
        style="color: red; padding: 10px; border: 1px solid red; background-color: #ffe6e6;">
        <strong>Access Denied:</strong> Unable to decrypt this message.
    </div>
    <div class="note note-content" style="filter: blur(5px); user-select: none;">
        [ENCRYPTED DATA PLACEHOLDER]
    </div>
    {% endif %}

    {% else %}
    {# Unencrypted Note (Legacy or Public) #}
    <div class="note note-content">
        {{ note.content_html }}
    </div>

    {% if note.attachments %}
    <div>
        <h3>Attachments</h3>
        <ul>
            {% for attachment in note.attachments %}
            <li>
                <strong>{{ attachment.filename }}</strong>
                <span>({{ (attachment.size / 1024)|round(1) }} KB)</span>
                <form action="{{ url_for('main.download_attachment', attachment_id=attachment.id) }}" method="POST">
                    <button type="submit">Download</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% endif %}

    <br><br>
    <a href="{{ url_for('main.profile') }}">Back to Profile</a>
</body>

</html>